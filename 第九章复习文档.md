[toc]

# 查询处理

# 查询优化

# 代数优化

查询树的启发式优化

转换的最终目的: 减少查询的开销（I/O次数）
转换的直接目的: 减少中间关系的元组数、元组大小
典型的启发式规则
（1）选择运算应尽可能先做（减小中间结果集的规模）
在优化策略中这是最重要、最基本的一条。
（2）把投影运算和选择运算同时进行（避免重复扫描）
如有若干投影和选择运算，并且它们都对同一个关系
操作，则可以在扫描此关系的同时完成所有的这些运
算以避免重复扫描关系。
（3） 把投影同其前或其后的双目运算结合起来，没有必要
为了去掉某些字段而扫描一遍关系。（避免重复扫描）
（4） 把某些选择同在它前面要执行的笛卡尔积结合起来成
为一个连接运算，连接特别是等值连接运算要比同样关系上
的笛卡尔积省很多时间。（避免重复扫描并减小中间结果集
的规模）
（5） 找出公共子表达式（避免重复计算）
 如果这种重复出现的子表达式的结果不是很大的关系，
并且从外存中读入这个关系比计算该子表达式的时间少
得多；
 则先计算一次公共子表达式并把结果写入中间文件是合
算的。
 当查询的是视图时，定义视图的表达式就是公共子表达
式的情况。



（1）分解选择运算

（2）通过交换选择运算，将其尽可能移到叶端

（3）通过交换投影运算，将其尽可能移到叶端

（4）合并串接的选择和投影，以便能同时执行或在一次扫描中完成

（5）对内结点分组

# 物理优化

代数优化改变查询语句中操作的次序和组合，不
涉及底层的存取路径
对于一个查询语句有许多存取方案，它们的执行
效率不同， 仅仅进行代数优化是不够的
物理优化就是要选择高效合理的操作算法或存取
路径，求得优化的查询计划

物理优化方法
 基于规则的启发式优化
		 启发式规则是指那些在大多数情况下都适用，但不是在
		每种情况下都是适用的规则。
		 基于代价估算的优化
		 优化器估算不同执行策略的代价，并选出具有最小代价
		的执行计划。
		 两者结合的优化方法：
		 常常先使用启发式规则，选取若干较优的候选方案，减
		少代价估算的工作量
		 然后分别计算这些候选方案的执行代价，较快地选出最
		终的优化方案

1. 选择操作的启发式规则
   对于小关系，使用全表顺序扫描，即使选择列上有索引
   对于大关系，启发式规则有：
  （1）对于选择条件是“主码＝值”的查询
   查询结果最多是一个元组，可以选择主码索引
   一般的关系数据库管理系统会自动建立主码索引
  （2）对于选择条件是“非主属性＝值”的查询，并且选择
  列上有索引
   要估算查询结果的元组数目
   如果比例较小(<10%)可以使用索引扫描方法
   否则还是使用全表顺序扫描
  （3）对于选择条件是属性上的非等值查询或者范围查询，
  并且选择列上有索引
   估算查询结果的元组数目，少则用索引，否则扫描全表
  （4）对于用AND连接的合取选择条件
   如果有涉及这些属性的组合索引
   优先采用组合索引扫描方法
   如果某些属性上有一般的索引，可以用索引扫描方法
   通过分别查找满足每个条件的指针，求指针的交集
   通过索引查找满足部分条件的元组，然后在扫描这些元组
  时判断是否满足剩余条件
   其他情况：使用全表顺序扫描
  （5）对于用OR连接的析取选择条件，一般使用全表顺序扫描

2. 连接操作的启发式规则
  （1）如果2个表都已经按照连接属性排序
   选用排序-合并算法
  （2）如果一个表在连接属性上有索引
   选用索引连接算法
  （3）如果上面2个规则都不适用，其中一个表较小
   选用Hash join算法
  （4）可以选用嵌套循环方法，并选择其中较小的表，确切地讲
  是占用的块数(b)较少的表，作为外表(外循环的表) 。
  理由：
   设连接表R与S分别占用的块数为Br与Bs
   连接操作使用的内存缓冲区块数为K
   分配K-1块给外表
   如果R为外表，则嵌套循环法存取的块数为Br+BrBs/(K-1)
   显然应该选块数小的表作为外表



启发式规则优化是定性的选择，适合解释执行的
系统
 解释执行的系统，优化开销包含在查询总开销之中
编译执行的系统中查询优化和查询执行是分开的
 可以采用精细复杂一些的基于代价的优化方法

1. 统计信息
2. 代价估算示例
3. 优化方法

2. 代价估算示例
  （1）全表扫描算法的代价估算公式
   如果基本表大小为B块，全表扫描算法的代价cost＝B
   如果选择条件是“码＝值”，那么平均搜索代价cost＝
  B/2
  （2）索引扫描算法的代价估算公式
   如果选择条件是“码＝值”
  则采用该表的主索引
  若为B+树，层数为L，需要存取B+树中从根结点到叶
  结点L块，再加上基本表中该元组所在的那一块，所
  以cost = L+1
   如果选择条件涉及非码属性例9.1-C3
  若为B+树索引，选择条件是相等比较，S是索引的选
  择基数(有S个元组满足条件)
  满足条件的元组可能会保存在不同的块上，所以(最坏
  的情况) cost = L+S

   如果比较条件是＞，＞＝，＜，＜＝操作
  假设有一半的元组满足条件，就要存取一半的叶结点
  通过索引访问一半的表存储块
  cost = L+Y/2+B/2
  如果可以获得更准确的选择基数，可以进一步修正
  Y/2与B/2

（3）嵌套循环连接算法的代价估算公式
 嵌套循环连接算法的代价
cost ＝ Br+BrBs/(K-1)
 如果需要把连接结果写回磁盘
cost ＝ Br+BrBs/(K-1)+(Frs*Nr*Ns)/Mrs
其中Frs为连接选择性(join selectivity)，表示连接
结果元组数的比例
Mrs是存放连接结果的块因子，表示每块中可以存放
的结果元组数目
（4）排序-合并连接算法的代价估算公式
 如果连接表已经按照连接属性排好序，则
cost ＝ Br+Bs+(Frs*Nr*Ns)/Mrs
 如果必须对文件排序
还需要在代价函数中加上排序的代价
对于包含B个块的文件排序的代价大约是
(2*B)+(2*B*log2B)