事务 ( 是用户定义的一个数据库 操作序列
这些操作要么全做，要么全不做，是一个 不可分割 的工作
单位。
事务和程序是两个概念
在关系数据库中，一个事务可以是一条 SQL 语句，一组
SQL 语句或整个程序
一个程序通常包含多个事务
事务是 恢复 和 并发控制 的基本单位

事务正常结束commit
提交 事务的所有操作（ 读 更新
事务中所有对数据库的更新写
回到磁盘上的物理数据库中

事务异常终止rollback
事务运行的过程中发生了故障，不能继续执行
系统将事务中对数据库的所有已完成的操作全
部撤销
事务滚回到 开始 时的状态

事务的
ACID 特性：
原子性（ Atomicity
一致性（ Consistency
隔离性（ Isolation
持续性（ Durability 一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。




发生系统故障时，一些尚未完成的事务的结果可
能已送入物理数据库，造成数据库可能处于不正
确状态。

恢复策略：系统重新启动时，恢复程序让所有非正常
终止的事务回滚，强行 撤消 UNDO ）所有未完成事
务




发生系统故障时，有些已完成的事务可能有一部
分甚至全部留在缓冲区，尚未写回到磁盘上的物
理数据库中，系统故障使得这些事务对数据库的
修改部分或全部丢失

恢复策略：系统重新启动时，恢复程序需要 重做
REDO ）所有已提交的事务




恢复操作的基本原理： 冗余

利用存储在系统别处的 冗余数据 来 重建 数据库中已被
破坏或不正确的那部分数据




转储是指数据库管理员定期地将整个数据库复制
到磁带、磁盘或其他存储介质上保存起来的过程

备用的数据文本称为 后备副本 ( 或 后援副
本


数据库遭到破坏后可以将后备副本重新装入

重装后备副本只能将数据库恢复到转储时的状态

要想恢复到故障发生时的状态，必须重新运行自
转储以后的所有更新事务

2.
转储方法
（
1 ）静态转储与动态转储
（
2 ）海量转储与增量转储
（
3 ）转储方法小结


静态转储

在系统中无运行事务时进行的转储操作

转储开始时数据库处于一致性状态

转储期间不允许对数据库的任何存取、修改活动

得到的一定是一个数据一致性的副本

优点：实现简单

缺点：降低了数据库的可用性

转储必须等待正运行的用户事务结束

新的事务必须等转储结束




动态转储

转储操作与用户事务并发进行

转储期间允许对数据库进行存取或修改

优点

不用等待正在运行的用户事务结束

不会影响新事务的运行

动态转储的缺点

不能保证副本中的数据正确有效

例 在转储期间的 某时刻 T c ，系统把数据 A=100 转储到磁
带上，而在下一时刻 T d ，某一事务将 A 改为 200 。
后备副本上的
A 过时 了


利用动态转储得到的副本进行故障恢复

需要把动态转储期间各事务对数据库的修改活动登记
下来，建立日志文件

后备副本加上日志文件就能把数据库恢复到某一时刻
的正确状态




海量转储 : 每次转储全部数据库

增量转储 : 只转储上次转储后更新过的数据

海量转储与增量转储比较

从恢复角度看，使用海量转储得到的后备副本进行恢
复往往更方便

如果数据库很大，事务处理又十分频繁，则增量转储
方式更实用更有效








以记录为单位的日志文件内容

各个事务的开始标记 (BEGIN

各个事务的结束标记 (COMMIT 或 ROLLBACK)

各个事务的所有更新操作
以上均作为日志文件中的一个日志记录


以记录为单位的日志文件，每条日志记录的内容

事务标识（标明是哪个事务）

操作类型（插入、删除或修改）

操作对象（记录 ID 、 Block NO.

更新前数据的旧值（对插入操作而言，此项为空值）

更新后数据的新值（对删除操作而言 , 此项为空值）




以数据块为单位的日志文件，每条日志记录的
内容

事务标识

被更新的数据块

**日志文件的作用**


用途

进行事务故障恢复

进行系统故障恢复

协助后备副本进行介质故障恢复




具体作用

事务故障恢复和系统故障恢复必须用日志文件。

在动态转储方式中必须建立日志文件，后备副本和日
志文件结合起来才能有效地恢复数据库。


在静态转储方式中，也可以建立日志文件。

当数据库毁坏后可重新装入后援副本把数据库恢复到转
储结束时刻的正确状态

利用日志文件，把已完成的事务进行重做处理

对故障发生时尚未完成的事务进行撤销处理

不必重新运行那些已完成的事务程序就可把数据库恢复
到故障前某一时刻的正确状态




为保证数据库是可恢复的，登记日志文件时必须遵循两条
原则

登记的次序严格按并发事务执行的时间 次序，写 到磁盘中
的日志记录顺序必须与写入日志缓冲区的 次序完全一致

必须先写日志文件，后写数据库

写日志文件操作：把表示这个修改的日志记录 写 到日志文件
中

写 数据库操作：把对数据的修改写到数据库 中




事务故障：事务在运行至正常终止点前被终止

恢复方法

由恢复子系统利用日志文件撤消（ UNDO ）此事务已
对数据库进行的修改

事务故障的恢复由系统自动完成，对用户是透明的，不需
要用户干预

（
1 反向扫描文件日志（即从最后向前扫描日志文件），
查找该事务的更新操作。
（
2 对该事务的更新操作执行逆操作。即将日志记录中
“更新前的值 写入数据库。

插入操作， ，“更新前的值”为空，则相当于做删除操作

删除操作，“更新后的值”为空，则相当于做插入操作

若是修改操作，则相当于用修改前值代替修改后值

（
3 继续反向扫描日志文件，查找该事务的其他更新操作，
并做同样处理。
（
4 如此处理下去，直至读到此事务的开始标记，事务故
障恢复就完成了。




系统故障造成数据库不一致状态的原因

未完成事务对数据库的更新可能已写入数据库

已提交事务对数据库的更新可能还留在缓冲区没来
得及写入数据库

恢复方法
1. Undo
故障发生时未完成的事务
2. Redo
已完成的事务

系统故障的恢复由系统在 重新启动时 自动完成，不需要
用户干预

（
1 ）正向扫描日志文件（即从头扫描日志文件

重做 (REDO) 队列 : 在故障发生前已经提交的事务

这些事务既有 BEGIN TRANSACTION 记录，也有
COMMIT 记录

撤销 ( 队列 故障发生时尚未完成的事务

这些事务只有 BEGIN TRANSACTION 记录，无相应的
COMMIT 记录

（
2 对撤销 ( 队列事务进行撤销 ( 处理

反向扫描日志文件，对每个撤销事务的更新操作执行逆
操作

即将日志记录中“更新前的值”写入数据库
（
3 ）对重做 ( 队列事务进行重做 ( 处理

正向扫描日志文件，对每个重做事务重新执行登记的操
作

即将日志记录中“更新后的值”写入数据库



10.5.3
介质故障的恢复
1
. 重 装数据库
2
. 重做 已完成的事务




具有检查点（ checkpoint ）的恢复技术

在日志文件中增加 检查点记录 checkpoint

增加重新开始文件

恢复子系统在登录日志文件期间动态地维护日志

检查点记录的内容

建立检查点时刻所有正在执行的事务清单

这些事务最近一个日志记录的地址

重新开始文件的内容

记录各个检查点记录在日志文件中的地址

动态维护日志文件的方法
周期性地执行如下操作：建立检查点，保存数据库状态。
具体步骤是：
（
1 ）将当前 日志 缓冲区中的所有日志记录写入磁盘的日志文件上
（
2 ）在日志文件中写入一个检查点记录
（
3 ）将当前 数据 缓冲区的所有数据记录写入磁盘的数据库中
（
4 ）把检查点记录在日志文件中的地址写入一个重新开始文件




恢复子系统可以定期或不定期地建立检查点 保存
数据库状态

定期

按照预定的一个时间间隔，如每隔一小时建立一个检查点

不定期

按照某种规则，如日志文件已写满一半建立一个检查点




使用检查点方法可以改善恢复效率

当事务 T 在一个检查点之前提交， T 对数据库所做的修
改已写入数据库

写入时间是在这个检查点建立之前或在这个检查点建
立之时

在进行恢复处理时，没有必要对事务 T 执行重做操作

看ppt89页

